# 交易数据库系统说明

## 📋 概述

完整的交易数据库系统，记录策略运行的所有数据：
- 指标信号
- OKX订单
- 交易记录
- 止损止盈记录

## 📊 数据库表结构

### 1. `indicator_signals` - 指标信号表
记录每个周期的指标和信号

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| timestamp | DateTime | 时间戳 |
| symbol | String | 交易对 |
| timeframe | String | 周期 |
| open_price | Float | 开盘价 |
| high_price | Float | 最高价 |
| low_price | Float | 最低价 |
| close_price | Float | 收盘价 |
| volume | Float | 成交量 |
| **indicators** | **JSON** | **指标数据（灵活扩展）** |
| signal_type | String | 信号类型 |
| signal_reason | Text | 信号原因 |
| position | String | 持仓方向 |
| entry_price | Float | 开仓价格 |
| stop_loss_level | Float | 止损位 |
| take_profit_level | Float | 止盈位 |
| created_at | DateTime | 创建时间 |

### 2. `okx_orders` - OKX订单表
记录所有OKX订单

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| order_id | String | OKX订单ID |
| symbol | String | 交易对 |
| order_type | String | 订单类型 |
| side | String | buy/sell |
| position_side | String | long/short |
| amount | Float | 合约数量 |
| price | Float | 价格 |
| average_price | Float | 成交均价 |
| filled | Float | 已成交数量 |
| **status** | **String** | **订单状态（与OKX同步）** |
| signal_id | Integer | 关联信号ID |
| trade_id | Integer | 关联交易ID |
| parent_order_id | String | 父订单ID |
| invested_amount | Float | 投入金额 |
| order_time | DateTime | 下单时间 |
| filled_time | DateTime | 成交时间 |

### 3. `okx_trades` - OKX交易记录表
记录完整交易周期（开仓+平仓）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| symbol | String | 交易对 |
| position_side | String | long/short |
| entry_signal_id | Integer | 开仓信号ID |
| exit_signal_id | Integer | 平仓信号ID |
| entry_order_id | String | 开仓订单ID |
| entry_price | Float | 开仓价格 |
| entry_time | DateTime | 开仓时间 |
| exit_order_id | String | 平仓订单ID |
| exit_price | Float | 平仓价格 |
| exit_time | DateTime | 平仓时间 |
| exit_reason | String | 平仓原因 |
| amount | Float | 合约数量 |
| invested_amount | Float | 投入金额 |
| **entry_fee** | **Float** | **开仓手续费（从OKX获取）** |
| **exit_fee** | **Float** | **平仓手续费（从OKX获取）** |
| **funding_fee** | **Float** | **资金费用（从OKX获取）** |
| **total_fee** | **Float** | **总费用** |
| profit_loss | Float | 盈亏金额 |
| net_profit_loss | Float | 净盈亏 |
| profit_loss_pct | Float | 盈亏百分比 |
| return_rate | Float | 收益率 |
| holding_duration | Integer | 持仓时长（秒） |
| status | String | open/closed |

### 4. `okx_stop_orders` - OKX止损止盈记录表
记录止损止盈单的创建、更新和触发

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| order_id | String | OKX条件单ID |
| symbol | String | 交易对 |
| trade_id | Integer | 关联交易ID |
| signal_id | Integer | 关联信号ID |
| entry_order_id | String | 开仓订单ID |
| order_type | String | STOP_LOSS/TAKE_PROFIT |
| position_side | String | long/short |
| trigger_price | Float | 触发价格 |
| order_price | Float | 委托价格 |
| **status** | **String** | **active/triggered/canceled/updated（与OKX同步）** |
| amount | Float | 合约数量 |
| old_trigger_price | Float | 旧触发价格 |
| update_reason | String | 更新原因 |
| update_count | Integer | 更新次数 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |
| **triggered_at** | **DateTime** | **触发时间（从OKX获取）** |
| **canceled_at** | **DateTime** | **取消时间（从OKX获取）** |

## 🔄 订单状态同步机制

### 订单状态映射

**普通订单状态:**
- `open` - 未成交
- `filled` - 完全成交
- `canceled` - 已撤销

**条件单状态:**
- `active` - 活跃中
- `triggered` - 已触发
- `canceled` - 已撤销
- `updated` - 已更新

### 同步时机

1. **下单后立即同步**
   - 保存订单到数据库
   - 获取初始状态

2. **定期同步（每分钟）**
   - 同步所有活跃订单状态
   - 更新止损止盈单状态

3. **平仓后同步**
   - 同步最终订单状态
   - 从OKX获取费用数据
   - 更新交易记录

## 🔧 使用方法

### 1. 测试数据库系统

```bash
cd /Users/Aylwin/strategy_copyto_coin/okx_trend_sar_single_period_boll
python test_trading_database.py
```

### 2. 集成到实盘交易

```python
from trading_database_service import TradingDatabaseService
from okx_fee_fetcher import OKXFeeFetcher
from okx_order_sync import OKXOrderSync

# 初始化
db_service = TradingDatabaseService('live_trading_data.db')
fee_fetcher = OKXFeeFetcher(exchange)
order_sync = OKXOrderSync(exchange)

# 保存指标信号
signal_id = db_service.save_indicator_signal(
    timestamp=timestamp,
    symbol=symbol,
    timeframe=timeframe,
    open_price=open_price,
    high_price=high_price,
    low_price=low_price,
    close_price=close_price,
    volume=volume,
    indicators_dict=indicators_dict,
    signal_type=signal_type,
    signal_reason=signal_reason
)

# 开仓
trade_id = db_service.create_okx_trade(...)
db_service.save_okx_order(...)  # 开仓订单
db_service.save_okx_stop_order(...)  # 止损单
db_service.save_okx_stop_order(...)  # 止盈单

# 同步订单状态
order_sync.sync_open_trade_orders(symbol, db_service)

# 平仓时获取费用
fees = fee_fetcher.get_trade_fees(
    entry_order_id=entry_order_id,
    exit_order_id=exit_order_id,
    symbol=symbol,
    entry_time=entry_time,
    exit_time=exit_time
)

# 关闭交易
db_service.close_okx_trade(
    trade_id=trade_id,
    exit_order_id=exit_order_id,
    exit_price=exit_price,
    exit_time=exit_time,
    exit_reason=exit_reason,
    entry_fee=fees['entry_fee'],
    exit_fee=fees['exit_fee'],
    funding_fee=fees['funding_fee']
)
```

## 📊 数据查询示例

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from trading_database_models import *

engine = create_engine('sqlite:///live_trading_data.db')
Session = sessionmaker(bind=engine)
session = Session()

# 查询所有交易记录
trades = session.query(OKXTrade).filter_by(status='closed').all()

# 查询盈利交易
profitable_trades = session.query(OKXTrade).filter(
    OKXTrade.net_profit_loss > 0
).all()

# 统计胜率
total_trades = session.query(OKXTrade).filter_by(status='closed').count()
winning_trades = session.query(OKXTrade).filter(
    OKXTrade.net_profit_loss > 0
).count()
win_rate = (winning_trades / total_trades * 100) if total_trades > 0 else 0

print(f"胜率: {win_rate:.2f}%")
```

## ⚠️ 注意事项

1. **OKX API限制**
   - 获取费用数据需要API权限
   - 注意API调用频率限制
   - 测试时使用测试环境

2. **数据一致性**
   - 定期同步订单状态
   - 平仓后必须获取实际费用
   - 检查数据库和OKX状态一致性

3. **错误处理**
   - API调用失败时的重试机制
   - 数据库操作的事务处理
   - 日志记录所有关键操作

## 🎯 下一步

1. ✅ 测试数据库基本操作
2. ✅ 测试OKX API获取费用
3. ⏭️ 集成到实盘交易系统
4. ⏭️ 添加定期同步任务
5. ⏭️ 实盘测试验证

## 📝 文件清单

- `trading_database_models.py` - 数据库模型定义
- `trading_database_service.py` - 数据库服务类
- `okx_fee_fetcher.py` - OKX费用获取器
- `okx_order_sync.py` - OKX订单状态同步器
- `test_trading_database.py` - 测试脚本
- `交易数据库系统说明.md` - 本文档


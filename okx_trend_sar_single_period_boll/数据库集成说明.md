# 📊 交易数据库系统集成说明

## ✅ 已完成的工作

### 1️⃣ 数据库表结构创建
- ✅ `indicator_signals` - 指标信号表
- ✅ `okx_trades` - OKX交易记录表
- ✅ `okx_orders` - OKX订单表
- ✅ `okx_stop_orders` - OKX止损止盈记录表

所有表已在MySQL数据库 `quantify` 中创建成功！

### 2️⃣ 数据库服务模块
- ✅ `trading_database_models.py` - SQLAlchemy数据模型
- ✅ `trading_database_service.py` - 数据库服务层
- ✅ `okx_fee_fetcher.py` - OKX手续费获取工具
- ✅ `okx_order_sync.py` - OKX订单状态同步工具

### 3️⃣ 实盘交易系统集成
已在 `live_trading_with_stop_orders.py` 中集成：

#### 📝 每次策略更新时自动保存
- 指标数据 → `indicator_signals` 表
  - SAR、布林带、RSI、ATR、EMA等所有指标
  - 当前持仓信息（如果有）
  - 交易信号（如果有）

#### 📝 开仓时自动保存
- 开仓订单 → `okx_orders` 表
- 交易记录 → `okx_trades` 表（状态：open）
- 止损单 → `okx_orders` + `okx_stop_orders`
- 止盈单 → `okx_orders` + `okx_stop_orders`

#### 📝 平仓时自动更新
- 更新交易记录状态 → `okx_trades`（状态：closed）
- 更新订单状态 → `okx_orders`
- 更新止损止盈状态 → `okx_stop_orders`
- 从OKX获取实际手续费和资金费

#### 📝 SAR止损更新时
- 更新止损单记录 → `okx_stop_orders`
- 记录旧止损价格和更新原因

---

## 🚀 如何使用

### 1️⃣ 配置数据库连接

在 `live_trading_with_stop_orders.py` 中已配置：

```python
trading_db_config = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': '',  # 填写你的MySQL密码
    'database': 'quantify',
    'charset': 'utf8mb4'
}
```

### 2️⃣ 启动实盘交易

```bash
cd /Users/Aylwin/strategy_copyto_coin/okx_trend_sar_single_period_boll
python3 live_trading_with_stop_orders.py
```

系统会自动：
- ✅ 连接MySQL数据库
- ✅ 开仓时保存所有订单信息
- ✅ 平仓时更新交易结果和费用
- ✅ SAR止损更新时记录变化

### 3️⃣ 查询交易数据

#### 查看最近的指标信号
```sql
SELECT * FROM indicator_signals 
ORDER BY timestamp DESC 
LIMIT 10;
```

#### 查看所有交易记录
```sql
SELECT * FROM okx_trades 
ORDER BY entry_time DESC;
```

#### 查看持仓中的交易
```sql
SELECT * FROM okx_trades 
WHERE status = 'open';
```

#### 查看已平仓的交易
```sql
SELECT 
    symbol,
    position_side,
    entry_price,
    exit_price,
    net_profit_loss,
    return_rate,
    holding_duration
FROM okx_trades 
WHERE status = 'closed'
ORDER BY exit_time DESC;
```

#### 查看止损止盈单
```sql
SELECT * FROM okx_stop_orders 
WHERE status = 'active'
ORDER BY created_at DESC;
```

#### 查看止损单更新历史
```sql
SELECT 
    order_id,
    order_type,
    old_trigger_price,
    trigger_price,
    update_reason,
    update_count,
    updated_at
FROM okx_stop_orders 
WHERE update_count > 0
ORDER BY updated_at DESC;
```

---

## 📊 数据流程图

```
1. 每次策略更新
   ↓
2. 保存指标数据:
   - indicator_signals (SAR/布林带/RSI/ATR/EMA等)
   ↓
3. 策略生成信号
   ↓
4. 开仓（OKX API）
   ↓
5. 保存到数据库:
   - okx_orders (开仓订单)
   - okx_trades (交易记录, status=open)
   - okx_stop_orders (止损止盈单)
   ↓
6. SAR止损更新
   ↓
7. 更新数据库:
   - okx_stop_orders (更新触发价格)
   - indicator_signals (保存新的指标状态)
   ↓
8. 平仓（触发止损或止盈）
   ↓
9. 从OKX获取实际费用
   ↓
10. 更新数据库:
   - okx_trades (status=closed, 计算盈亏)
   - okx_orders (更新状态)
   - okx_stop_orders (标记为triggered)
```

---

## 🔍 测试验证

### 测试数据库连接
```bash
python3 test_mysql_connection.py
```

### 测试完整流程
```bash
python3 test_trading_database.py
```

---

## ⚠️ 注意事项

1. **密码安全**
   - 不要在代码中硬编码MySQL密码
   - 建议使用环境变量或配置文件

2. **数据完整性**
   - 所有订单信息都会自动保存
   - 如果保存失败会打印错误但不影响交易

3. **费用计算**
   - 开仓时费用是估算值（invested_amount × 0.02%）
   - 平仓后会从OKX API获取实际费用

4. **指标数据存储**
   - `indicator_signals` 表的 `indicators` 字段使用JSON格式
   - 可以灵活存储任意指标数据

5. **查询性能**
   - 已为常用查询字段创建索引
   - 大量数据时建议定期归档历史数据

---

## 📝 下一步计划

- [ ] 添加定时任务同步OKX订单状态
- [ ] 实现交易数据可视化Dashboard
- [ ] 添加风险监控和告警
- [ ] 实现策略绩效统计报表
- [ ] 支持多策略并行运行

---

## 🎉 总结

现在你的实盘交易系统已经完整集成了MySQL数据库：
1. ✅ 所有订单自动保存
2. ✅ 交易记录完整追踪
3. ✅ 止损止盈动态记录
4. ✅ 费用和盈亏准确计算

可以放心运行实盘交易了！🚀


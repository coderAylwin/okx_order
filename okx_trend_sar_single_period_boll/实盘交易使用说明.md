# OKX 实盘交易系统使用说明

## 📋 目录

1. [系统概述](#系统概述)
2. [安全注意事项](#安全注意事项)
3. [配置步骤](#配置步骤)
4. [运行实盘](#运行实盘)
5. [监控和管理](#监控和管理)
6. [故障处理](#故障处理)

---

## 系统概述

本系统基于 **SAR + Bollinger Bands** 策略，自动在 OKX 交易所执行交易。

### 核心功能

- ✅ 实时获取市场数据
- ✅ 自动执行开仓/平仓
- ✅ 动态止损（SAR线跟随）
- ✅ 固定止盈（可配置）
- ✅ 风险控制和异常处理
- ✅ 完整的交易日志

### 交易模式

1. **模拟盘模式** (`mode='paper'`): 使用 OKX 沙盒环境
2. **实盘模式** (`mode='live'`): 真实交易
3. **测试模式** (`test_mode=True`): 只打印信号，不实际下单

---

## 安全注意事项

### ⚠️ 重要警告

1. **API密钥安全**
   - 不要将API密钥上传到Git
   - 不要分享给他人
   - 建议使用只读权限先测试

2. **资金安全**
   - 先在模拟盘测试
   - 使用小资金测试
   - 设置合理的止损

3. **监控要求**
   - 定期检查运行状态
   - 监控账户余额
   - 注意异常日志

---

## 配置步骤

### 步骤 1: 获取 OKX API 密钥

1. 登录 [OKX官网](https://www.okx.com)
2. 进入 API 管理页面
3. 创建 API Key
4. 记录：API Key, Secret Key, Passphrase

### 步骤 2: 配置 API 密钥

编辑 `okx_config.py` 文件：

```python
OKX_API_CONFIG = {
    'api_key': '你的_API_KEY',           # 填入你的 API Key
    'secret': '你的_SECRET_KEY',          # 填入你的 Secret Key
    'password': '你的_PASSPHRASE',        # 填入你的 Passphrase
    'enableRateLimit': True,
    'options': {
        'defaultType': 'swap',
    }
}
```

### 步骤 3: 配置交易参数

编辑 `okx_config.py` 中的交易配置：

```python
TRADING_CONFIG = {
    'mode': 'paper',        # 'paper'=模拟盘, 'live'=实盘
    'test_mode': True,      # True=测试模式（只打印不下单）
    
    # 风险控制
    'max_position_value': 10000,  # 最大持仓价值
    'update_interval': 60,         # 更新间隔（秒）
}
```

### 步骤 4: 配置策略参数

编辑 `strategy_configs.py`：

```python
config = {
    'long_coin': 'BTC',               # 交易币种
    'timeframe': '30m',               # 时间周期
    'fixed_take_profit_pct': 0.5,    # 固定止盈 0.5%
    'max_loss_pct': 0,                # 最大亏损（0=禁用）
    # ... 其他参数
}
```

---

## 运行实盘

### 模式 1: 测试模式（推荐新手）

**只打印信号，不实际下单**

```bash
# 确保配置为测试模式
# okx_config.py 中设置:
# 'mode': 'paper'
# 'test_mode': True

cd /Users/Aylwin/trade_okx/trend_sar_single_period_boll
python3 live_trading.py
```

**预期输出**:
```
🧪 【测试模式】模拟开多单: BTC-USDT-SWAP, 数量: 0.01
✅ 开多单成功！
```

### 模式 2: 模拟盘模式

**使用 OKX 沙盒环境，真实下单但不影响实盘资金**

```bash
# 修改 okx_config.py:
# 'mode': 'paper'
# 'test_mode': False  # 实际下单

python3 live_trading.py
```

### 模式 3: 实盘模式 ⚠️

**真实市场交易，会实际扣除资金！**

```bash
# 修改 okx_config.py:
# 'mode': 'live'
# 'test_mode': False

python3 live_trading.py

# 系统会要求输入 'YES' 确认
```

---

## 监控和管理

### 查看运行状态

程序会每隔一段时间显示：
- ✅ 当前K线数据
- ✅ 策略信号
- ✅ 持仓状态
- ✅ 交易统计

### 查看日志

日志文件位置：
```
live_trade_logs/
  - trade_log_20251013.txt     # 文本日志
  - trade_log_20251013.json    # JSON格式日志
```

### 停止程序

按 `Ctrl+C` 优雅退出，程序会：
- 打印最终统计
- 关闭数据库连接
- 保存日志

---

## 运行流程

### 启动流程

1. ✅ 初始化 OKX API 连接
2. ✅ 加载历史数据预热策略（60天）
3. ✅ 同步持仓状态
4. ✅ 进入监控循环

### 监控循环（每60秒）

1. 获取最新1分钟K线
2. 更新策略指标
3. 检查交易信号
4. 执行交易操作
5. 记录日志

### 交易执行

**开仓信号** → 检查资金 → 计算数量 → 下单 → 设置止损/止盈

**平仓信号** → 检查持仓 → 平仓 → 记录盈亏

---

## 风险控制

### 内置风险控制

- ✅ 最大持仓限制
- ✅ 最小下单量限制
- ✅ API调用重试机制
- ✅ 异常自动恢复

### 手动风险控制

1. **设置止损**
   ```python
   'max_loss_pct': 2  # 最大亏损2%
   ```

2. **限制资金量**
   ```python
   'initial_capital': 1000  # 只用1000 USDT
   ```

3. **限制持仓价值**
   ```python
   'max_position_value': 5000  # 最大持仓5000 USDT
   ```

---

## 故障处理

### 问题 1: API连接失败

**原因**: API密钥错误或网络问题

**解决**:
1. 检查 `okx_config.py` 中的API密钥
2. 检查网络连接
3. 确认API权限（需要交易权限）

### 问题 2: 下单失败

**原因**: 余额不足、最小下单量、仓位限制

**解决**:
1. 检查账户余额
2. 调整 `position_size_percentage`
3. 检查交易对规则

### 问题 3: 数据获取失败

**原因**: 数据库无历史数据、网络问题

**解决**:
1. 确保运行了 `Okx1m.py` 拉取历史数据
2. 检查数据库连接
3. 检查币种和时间配置

### 问题 4: 持仓不同步

**原因**: 手动交易、程序重启

**解决**:
1. 程序启动时会自动同步持仓
2. 如果不一致，手动平仓或修改代码
3. 建议不要手动交易

---

## 最佳实践

### 1. 测试流程

```
步骤1: 测试模式运行3天
  ↓
步骤2: 模拟盘运行1周
  ↓
步骤3: 实盘小资金测试1周
  ↓
步骤4: 正式运行
```

### 2. 监控要点

- ✅ 每天检查交易日志
- ✅ 每周分析交易统计
- ✅ 注意异常波动
- ✅ 定期调整参数

### 3. 资金管理

- 建议只用闲置资金的 10-20%
- 设置合理的止损（2-5%）
- 不要满仓交易
- 保持足够的保证金

---

## 目录结构

```
trend_sar_single_period_boll/
├── okx_config.py              # OKX API配置
├── okx_trader.py              # 交易接口封装
├── live_trading.py            # 实盘交易主程序
├── trade_logger.py            # 日志记录系统
├── strategy_configs.py        # 策略参数配置
├── trend_sar_single_period_boll_strategy.py  # 策略实现
└── live_trade_logs/           # 交易日志目录
    ├── trade_log_20251013.txt
    └── trade_log_20251013.json
```

---

## 快速开始

### 1. 配置API密钥

```bash
# 编辑 okx_config.py
vim okx_config.py
```

### 2. 设置为测试模式

```python
# okx_config.py
TRADING_CONFIG = {
    'mode': 'paper',
    'test_mode': True,  # 测试模式
}
```

### 3. 运行程序

```bash
python3 live_trading.py
```

### 4. 观察输出

程序会显示：
- 策略初始化信息
- 数据预热进度
- 实时K线和信号
- 交易执行结果

### 5. 停止程序

按 `Ctrl+C` 停止

---

## 常见命令

### 启动实盘

```bash
# 后台运行
nohup python3 live_trading.py > live_trading.log 2>&1 &

# 查看日志
tail -f live_trading.log
```

### 停止实盘

```bash
# 查找进程
ps aux | grep live_trading.py

# 停止进程（优雅退出）
kill -SIGINT <PID>
```

### 查看交易日志

```bash
# 查看今日日志
tail -f live_trade_logs/trade_log_$(date +%Y%m%d).txt

# 查看JSON日志
cat live_trade_logs/trade_log_$(date +%Y%m%d).json | jq
```

---

## 紧急情况处理

### 1. 市场异常波动

- 立即停止程序（`Ctrl+C`）
- 手动检查持仓
- 必要时手动平仓

### 2. 程序异常退出

- 检查日志文件
- 确认持仓状态
- 重启程序（会自动同步持仓）

### 3. API限流

- 降低更新频率（`update_interval`）
- 检查API调用频率
- 等待一段时间后重试

---

## 技术支持

### 日志位置

- 文本日志: `live_trade_logs/trade_log_YYYYMMDD.txt`
- JSON日志: `live_trade_logs/trade_log_YYYYMMDD.json`
- 控制台输出: `live_trading.log`

### 配置文件

- API配置: `okx_config.py`
- 策略配置: `strategy_configs.py`
- 数据库配置: `database_config.py`

---

## ⚠️ 免责声明

- 量化交易有风险，投资需谨慎
- 本系统仅供学习研究使用
- 使用本系统造成的损失由使用者自行承担
- 建议在模拟盘充分测试后再使用实盘

---

**祝你交易顺利！🚀**


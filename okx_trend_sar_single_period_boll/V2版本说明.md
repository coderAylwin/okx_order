# OKX交易系统 V2版本 - 优化手续费版

## 🎯 核心改进

### **目标：最大化省手续费**
- ✅ 使用限价单代替市价单
- ✅ 通过WebSocket实时获取订单簿
- ✅ 优先成为Maker（0.02%手续费 vs 0.05% Taker）

---

## 📊 手续费对比

| 订单类型 | 角色 | 手续费率 | 说明 |
|---------|------|---------|------|
| **限价单（Maker）** | 流动性提供者 | **0.02%** | ✅ 最优 |
| **市价单（Taker）** | 流动性消耗者 | **0.05%** | ❌ 贵2.5倍 |

### 举例（ETH合约，3张，价值$1149）
- Maker手续费：$1149 × 0.02% = **$0.23**
- Taker手续费：$1149 × 0.05% = **$0.57**
- **省$0.34/笔，节省60%手续费**

---

## 🚀 新增功能

### 1. **WebSocket订单簿监听器** (`okx_orderbook_watcher.py`)

**功能：**
- 实时订阅OKX books5频道
- 获取实时5档买卖盘数据
- 线程安全的数据缓存

**使用示例：**
```python
from okx_orderbook_watcher import OKXOrderbookWatcher

# 创建订单簿监听器
watcher = OKXOrderbookWatcher(['ETH-USDT-SWAP'], test_mode=False)
watcher.start()

# 获取买3价/卖3价
bid3 = watcher.get_bid_price('ETH-USDT-SWAP', level=3)
ask3 = watcher.get_ask_price('ETH-USDT-SWAP', level=3)

# 打印订单簿
watcher.print_orderbook('ETH-USDT-SWAP')
```

---

### 2. **优化版交易接口** (`okx_trader_v2.py`)

**核心改进：**

#### **开多单策略（省手续费）：**
```
时间轴：
0秒   → 获取订单簿，挂买3价限价单
30秒  → 检查成交状态
      ├─ 已成交 → 手续费0.02% (Maker) ✅
      └─ 未成交 → 撤单重挂买3价
60秒  → 再次检查
      ├─ 已成交 → 手续费0.02% (Maker) ✅
      └─ 未成交 → 吃卖1价（市价单）
                  手续费0.05% (Taker) ❌
```

**预期成交率：**
- 80-90% 以Maker成交（省手续费）
- 10-20% 以Taker成交（确保成交）

#### **开空单策略：**
```
同理，挂卖3价限价单，策略相同
```

---

### 3. **止盈止损优化**

**新逻辑：**
```python
开仓成功后：
1. 尝试挂止损限价单（价格=触发价±0.1%）
2. 尝试挂止盈限价单（价格=触发价±0.1%）
3. 如果挂单失败（价格超出限制）：
   - 启动价格监听模式
   - 价格接近时自动重试挂单
   - 必要时使用市价单强制平仓
```

**优点：**
- 止损止盈也使用限价单（省手续费）
- 价格监听确保不错过触发点
- 支持动态调整止损价

---

## 📁 文件说明

### **新增文件：**

1. **`okx_orderbook_watcher.py`**
   - WebSocket订单簿监听器
   - 实时获取5档买卖盘
   - 提供买3/卖3价格查询接口

2. **`okx_trader_v2.py`**
   - 优化版交易接口
   - 集成订单簿定价
   - 限价单优先策略
   - 30秒+30秒+吃单的三阶段开仓

3. **`V2版本说明.md`**
   - 本文档

### **保留文件（兼容性）：**

- `okx_trader_enhanced.py` - 原版交易接口
- `live_trading_with_stop_orders.py` - 原版实盘交易脚本

---

## 🔧 使用方法

### **方式1：直接使用V2交易接口**

```python
from okx_trader_v2 import OKXTraderV2

# 初始化
trader = OKXTraderV2(
    test_mode=False,
    leverage=3,
    symbols=['ETH-USDT-SWAP']
)

# 开多单
result = trader.open_long_with_limit_order(
    symbol='ETH-USDT-SWAP',
    amount=3.59,
    stop_loss_price=3717.5,
    take_profit_price=3851.9
)

# 开空单
result = trader.open_short_with_limit_order(
    symbol='ETH-USDT-SWAP',
    amount=3.59,
    stop_loss_price=3857.9,
    take_profit_price=3798.1
)
```

### **方式2：集成到现有实盘脚本**

修改 `live_trading_with_stop_orders.py`：
```python
# 将
from okx_trader_enhanced import OKXTraderEnhanced

# 改为
from okx_trader_v2 import OKXTraderV2 as OKXTraderEnhanced
```

然后将开仓方法调用改为：
```python
# 将
trader.open_long_with_stop_orders(...)

# 改为
trader.open_long_with_limit_order(...)
```

---

## ⚙️ 依赖安装

```bash
pip install websocket-client
```

---

## 📊 预期效果

### **每笔交易节省手续费：**

假设每天交易5笔，每笔价值$1000：

```
原版（市价单）：
$1000 × 0.05% × 5笔 × 2（开+平） = $5.00/天

V2版（限价单，80%成功率）：
开仓：$1000 × (0.02% × 4 + 0.05% × 1) × 5笔 = $0.65
平仓：$1000 × 0.02% × 5笔 = $1.00
总计：$1.65/天

节省：$5.00 - $1.65 = $3.35/天
```

**每月节省：$3.35 × 30 = $100.5**

---

## ⚠️ 注意事项

1. **网络延迟**
   - WebSocket需要稳定网络
   - 建议服务器部署在香港/新加坡

2. **订单簿深度**
   - 确保买3/卖3有足够流动性
   - 极端行情可能需要吃单

3. **成交时机**
   - 60秒超时可能错过最佳价格
   - 可根据市场调整超时时间

4. **价格监听**
   - 止损止盈监听需要持续运行
   - 建议使用系统服务（systemd）

---

## 🎯 下一步优化方向

1. ✅ 已完成：基础限价单策略
2. ✅ 已完成：WebSocket订单簿
3. ⏳ 待实现：价格监听器（独立线程）
4. ⏳ 待实现：动态调整挂单位置（买3→买2→买1）
5. ⏳ 待实现：统计成交率和手续费节省数据
6. ⏳ 待实现：钉钉通知（手续费节省报告）

---

## 📞 技术支持

如有问题，请查看：
1. 日志输出（详细的执行信息）
2. OKX API文档
3. WebSocket连接状态

---

**版本：** V2.0  
**更新日期：** 2025-10-23  
**状态：** 测试中 ✅


# 钉钉消息推送功能说明

## 📱 功能概述

策略已集成钉钉webhook消息推送功能，可以在关键时刻自动推送消息到钉钉群：

1. **周期结束时推送指标信息**（每个K线周期结束时）
2. **开仓时推送消息**（做多/做空）
3. **平仓时推送消息**（盈利/亏损）

## 🔧 配置方法

### 1. 在配置文件中添加webhook地址和加签密钥

已在 `strategy_configs.py` 中配置：

```python
# 🔴 钉钉消息推送配置
'dingtalk_webhook': 'https://oapi.dingtalk.com/robot/send?access_token=8eecf36111e7448c7dc26244f33e69d0bdd12cfb7b53457882ea725069d74cc1',
'dingtalk_secret': 'SEC8f4556064e9c31374422530eab63a65561f2bac0b8d1c3e7cfcaa2b8b4d44686',  # 加签密钥
```

### 2. 加签说明

如果钉钉机器人设置了**加签验证**（安全设置），必须配置 `dingtalk_secret` 参数：

- `dingtalk_secret`：钉钉机器人的加签密钥（以"SEC"开头的字符串）
- 系统会自动生成签名并添加到请求URL中
- 签名算法：HmacSHA256 + Base64编码

### 3. 如需禁用推送

将webhook设置为 `None` 或空字符串：

```python
'dingtalk_webhook': None  # 禁用推送
```

## 📊 推送消息内容

### 1. 周期指标更新消息

**触发时机**：每个K线周期结束时

**包含信息**：
- ⏰ 时间戳
- 📊 SAR值和方向
- 📈 RSI指标
- 📏 布林带（上轨/中轨/下轨）
- 💼 持仓信息（如有）
  - 持仓方向（做多/做空）
  - 开仓价格
  - 当前价格
  - 止损价格
  - 止盈价格
  - 当前盈亏百分比

### 2. 开仓通知

**触发时机**：执行开仓操作时

**包含信息**：
- 🟢/🔴 开仓方向（做多/做空）
- ⏰ 开仓时间
- 💰 开仓价格
- 💵 投入资金
- 📊 持仓份额
- 🛡️ 止损价格
- 🎯 止盈价格
- 🛑 最大亏损价格
- 📝 开仓原因

### 3. 平仓通知

**触发时机**：执行平仓操作时

**包含信息**：
- ✅/❌ 平仓结果（盈利/亏损）
- ⏰ 平仓时间
- 📈 开仓价格
- 📉 平仓价格
- 💰 盈亏金额
- 📊 收益率
- 📝 平仓原因

## 🧪 测试方法

运行测试脚本验证推送功能：

```bash
cd /Users/Aylwin/strategy_copyto_coin/okx_trend_sar_single_period_boll
python test_dingtalk.py
```

测试脚本会发送6条测试消息：
1. 指标更新（无持仓）
2. 指标更新（有持仓）
3. 开多单
4. 开空单
5. 盈利平仓
6. 亏损平仓

## 📝 消息格式示例

### 指标更新消息示例

```markdown
## 📊 15m周期指标更新

**⏰ 时间**: 2025-10-14 15:30:00

---

**SAR值**: 2500.50 📈 上升

**RSI**: 55.32

**布林带**:
- 上轨: 2550.00
- 中轨: 2500.00
- 下轨: 2450.00

---

## 💼 持仓信息

**持仓方向**: 🟢 做多

**开仓价格**: $2480.00

**当前价格**: $2510.00

**止损价格**: $2460.00

**止盈价格**: $2520.00

**当前盈亏**: 📈 +1.21%
```

### 开仓消息示例

```markdown
## 🟢 开仓通知 - 做多

**⏰ 时间**: 2025-10-14 15:30:00

---

**开仓价格**: $2480.00

**投入资金**: $50,000.00

**持仓份额**: 20.0000

**止损价格**: $2460.00

**止盈价格**: $2520.00

---

**开仓原因**:

SAR转多开仓 | 条件：SAR方向short→long | RSI过滤：55.32≤70
```

### 平仓消息示例

```markdown
## ✅ 平仓通知 - 做多

**⏰ 时间**: 2025-10-14 16:00:00

---

**开仓价格**: $2480.00

**平仓价格**: $2520.00

**盈利金额**: 📈 +$800.00

**收益率**: 📈 +1.61%

---

**平仓原因**:

多单固定止盈 | 条件：价格$2520.00≥止盈位$2520.00
```

## ⚠️ 注意事项

1. **网络连接**：确保运行策略的机器能够访问钉钉webhook地址
2. **消息频率**：周期结束时会推送指标消息，请根据时间周期调整
3. **webhook安全**：不要将webhook地址泄露给他人
4. **错误处理**：推送失败不会影响策略运行，会在控制台输出错误信息

## 🔗 相关文件

- `dingtalk_notifier.py` - 钉钉推送模块
- `test_dingtalk.py` - 测试脚本
- `strategy_configs.py` - 配置文件
- `trend_sar_single_period_boll_strategy.py` - 策略主文件

